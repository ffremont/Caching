<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Cache ou pas cache</title>

        <meta name="author" content="Florent FREMONT">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/sky.css" id="theme">

        <!-- Code syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName('head')[0].appendChild(link);
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section>
                    <h1>Cache ou pas cache</h1>
                    <h2>Le cache 2.0</h2>
                    <p>
                        <small>Par Florent FREMONT</small>
                    </p>
                </section>

                <section>
                    <h2>Sommaire</h2>
                    <ul>
                        <li>Verbes HTTP</li>
                        <li>La vie sans cache</li>
                        <li>Please, pas de cache !</li>
                        <li>Le cache mais quand ?</li>
                        <li>Cache par expiration</li>
                        <li>Cache par validation</li>
                        <li>Un petit mixte :s</li>
                        <li>Références</li>
                        <!-- https://www.fir3net.com/Networking/Protocols/http-caching-http-1-0-vs-http-1-1.html -->
                        <!-- https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=fr#cache-control -->
                        <!-- https://www.mnot.net/cache_docs/index.fr.html#CACHE-CONTROL -->
                        <!-- https://devcenter.heroku.com/articles/increasing-application-performance-with-http-cache-headers -->
                        <!-- https://developer.mozilla.org/fr/docs/Web/HTTP/Caching_FAQ -->
                    </ul>
                </section>

                <section>
                    <h2>Verbes HTTP</h2>

                    <img src="img/verbs.png"/>
                </section>

                <section>
                    <section>
                        <h2>La vie sans cache</h2>

                        <ul>
                            <li>IE 10 : en cache</li>
                            <li>Chrome & Firefox : sans cache</li>
                            <li>Conclusion</li>
                        </ul>
                    </section>
                    <section>
                        <h2>La vie sans cache</h2>
                        <h3>IE 10 : en cache</h3>

                        <p>
                            La réponse HTTP est automatiquement <strong>mise en cache </strong> malgré l'absence d'entête de cache
                        </p>
                        <img src="img/ie_cache_rien_response_ok.png"/>
                        <img src="img/ie_cache_rien_response.png"/>
                    </section>

                    <section>
                        <h2>La vie sans cache</h2>
                        <h3>Chrome & Firefox : sans cache</h3>

                        <p>
                            La réponse HTTP  n'est<strong> pas mise en cache </strong>
                        </p>
                        <img src="img/chrome_rien_ok.png" />
                    </section>

                    <section>
                        <h2>La vie sans cache</h2>
                        <h3>Conclusion</h3>

                        <p>
                            <strong>Il faut définir explicitement le cache</strong>
                        </p>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Please, pas de cache !</h2>

                        <p>Je ne veux pas de cache pour ma réponse HTTP</p>
                        <ul>
                            <li>Old school : HTTP 1.0</li>
                            <li>HTTP 1.1</li>
                            <li>En pratique</li>
                        </ul>
                    </section>

                    <section>
                        <h2>Please, pas de cache !</h2>
                        <h3>Old school : HTTP 1.0</h3>

                        <ul>
                            <li>Entête de la requête
                                <ul>
                                    <li>Pragma : no-cache</li>
                                </ul>
                            </li>
                            <li>Entête de la réponse
                                <ul>
                                    <li>Pragma : no-cache</li>
                                    <li>Expires : 0</li>
                                </ul>
                            </li>
                        </ul>
                        <p>
                            Il est intéressant de noter que « Expire: 0 »et« Pragma: no-cache "sont têtes de réponse techniquement <strong>invalides</strong>
                        </p>


                        <!-- https://www.fir3net.com/Networking/Protocols/http-caching-http-1-0-vs-http-1-1.html -->
                    </section>

                    <section>
                        <h2>Please, pas de cache !</h2>
                        <h3>HTTP 1.1</h3>
                        <h4>Cache-control : no-cache</h4>

                        <p>
                            <strong>‘no-cache’</strong> indique que la réponse renvoyée ne peut pas être utilisée pour satisfaire une requête ultérieure à la même URL sans avoir au préalable vérifié auprès du serveur si la réponse a changé. En conséquence, si un jeton de validation adapté (ETag) est présent, l’élément no-cache induit un aller-retour pour valider la réponse mise en cache, mais peut éliminer le téléchargement si la ressource n’a pas changé.
                        </p>
                    </section>
                    <section>
                        <h2>Please, pas de cache !</h2>
                        <h3>HTTP 1.1</h3>
                        <h4>Cache-control : no-store</h4>

                        <p>
                            <strong>‘no-store’</strong> est beaucoup plus simple, puisqu’il interdit au navigateur et à tout cache intermédiaire de stocker toute version de la réponse renvoyée. C’est la cas par exemple des réponses qui contiennent des données confidentielles, personnelles ou bancaires. Chaque fois que l’utilisateur demande cet élément, une requête est envoyée au serveur et une réponse complète est téléchargée.
                        </p>
                    </section>
                    <section>
                        <h2>Please, pas de cache !</h2>
                        <h3>HTTP 1.1</h3>

                        <ul>
                            <li>Cache-control
                                <ul>
                                    <li><strong>no-store</strong></li>
                                    <li><strong>no-cache : <a href="http://support2.microsoft.com/default.aspx?scid=KB;EN-US;Q234067">merci IE </a></strong></li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h2>Please, pas de cache !</h2>
                        <h3>HTTP 1.1</h3>
                        <h4>Navigateurs</h4>

                        <ul>
                            <li>Chrome & Firefox : 200 Ok</li>
                            <li>IE 10 : 200 Ok
                                <img src="img/ie_cache_and_nocache.png" />
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h2>Please, pas de cache !</h2>
                        <h3>En pratique</h3>

                        <pre><code>
@GET
@Path("disablecache")
public Response disablecache(){
    javax.ws.rs.core.CacheControl cache = new javax.ws.rs.core.CacheControl();
    cache.setNoCache(true); // pour IE 
    cache.setNoStore(true); // HTTP 1.1 demande juste no-store

    return Response.ok("Pas de cache").cacheControl(cache).build();
}
    </code></pre>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Le cache mais quand ?</h2>

                        <ul>
                            <li>Un petit schéma</li>
                            <li>public ou private</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Le cache mais quand ?</h2>

                        <img src="img/http-cache-decision-tree.png" />
                    </section>
                    <section>
                        <h2>Le cache mais quand ?</h2>
                        <h3><strong>public</strong> ou private</h3>


                        <p>Si la réponse est marquée comme étant <strong>publique</strong>, elle peut être mise en cache, même si elle est associée à une authentification HTTP, et même si le code d’état de la réponse ne peut normalement pas être mis en cache. La plupart du temps l’élément public n’est pas nécessaire, car les informations de mises en cache explicites, telles que max-age, indiquent que la réponse peut quand même être mise en cache.</p>
                    </section>
                    <section>
                        <h2>Le cache mais quand ?</h2>
                        <h3>public ou <strong>private</strong></h3>

                        <p>Les réponses portant l’élément <strong>private</strong> peuvent être mises en cache par le navigateur, mais concernent généralement un seul utilisateur, et ne peuvent donc pas être mises en cache par un cache intermédiaire. Par exemple, une page HTML contenant des informations confidentielles sur l’utilisateur peut être mise en cache par le navigateur de cet utilisateur, mais pas par un CDN.</p>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Cache par expiration</h2>

                        <ul>
                            <li>Cache-control & max-age</li>
                            <li>En pratique</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Cache par expiration</h2>
                        <h3>max-age ?</h3>
                        <p>
                            Cette directive indique la durée maximale en secondes pendant laquelle la réponse récupérée peut être réutilisée, à partir de l’envoi de la requête. Par exemple, max-age=60 indique que la réponse peut être mise en cache et réutilisée pendant les 60 secondes qui suivent.
                        </p>
                    </section>
                    <section>
                        <h2>Cache par expiration</h2>
                        <h3>En pratique</h3>

                        <pre><code>
@GET
@Path("use60sec")
public Response use1sec() {
    javax.ws.rs.core.CacheControl cache = new javax.ws.rs.core.CacheControl();
    cache.setMaxAge(60);
    cache.setPrivate(false);

    return Response.ok("En cache pendant 60 sec").cacheControl(cache).build();
}
</code></pre>
                    </section>
                    <section>
                        <h2>Cache par expiration</h2>
                        <h3>En pratique</h3>
                        <h4>Ex. chrome</h4>

                        <img src="img/chrome_maxage_60sec.png" />
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Cache par validation</h2>

                        <ul>
                            <li>Basé sur le temps</li>
                            <li>Basé sur le contenu</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h2>Cache par validation</h2>
                        <h3>Basé sur le temps</h3>
                        <h4>Sur le papier</h4>
                        
                        <p>L'idée est de mettre en cache une ressource un certain temps tout en vérifiant qu'elle n'a pas été modifiée.</p>
                        <ul>
                            <li>Request HTTP
                                <ul>
                                    <li>If-Modified-Since</li>
                                </ul>
                            </li>
                            <li>Réponse HTTP
                                <ul>
                                    <li>Cache-control : max-age=XXX</li>
                                    <li>Last-Modified</li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    
                    <section>
                        <h2>Cache par validation</h2>
                        <h3>Basé sur le temps</h3>
                        
                        <img src="img/FF_validation_tmps.png" />
                        <pre><code>
@Path("cachecontrol")
public class CacheControl {

    @Context
    private HttpServletRequest request;
    
    @GET
    @Path("validationtps")
    public Response validationTps() {
        javax.ws.rs.core.CacheControl cache = new javax.ws.rs.core.CacheControl();
        cache.setMaxAge(60);
        cache.setPrivate(false);
        
        if(request.getHeader("If-Modified-Since") != null){
            // ma ressource est encore bonne
            return Response.status(Response.Status.NOT_MODIFIED).build();            
        }        

        return Response.ok("Ma petite donnée").lastModified(Date.from(Instant.now())).cacheControl(cache).build();
    }
}
</code></pre>
                    </section>
                    
                    <section>
                        <h2>Cache par validation</h2>
                        <h3>Basé sur le contenu</h3>
                        
                        <p>Le serveur compare le jeton, et s'il n'a pas changé il retourne une 304 Not modified. Le cache sera renouvelé 120 sec suppl. Un noueau téléchargement n'est pas nécessaire.</p>
                    
                        <img src="img/http-cache-control.png" />
                    </section>
                </section>

                <section>
                    <h2>Références</h2>

                    <ul>
                        <li>https://www.fir3net.com/Networking/Protocols/http-caching-http-1-0-vs-http-1-1.html</li>
                        <li>https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=fr#cache-control</li>
                        <li>https://www.mnot.net/cache_docs/index.fr.html#CACHE-CONTROL</li>
                        <li>https://devcenter.heroku.com/articles/increasing-application-performance-with-http-cache-headers</li>
                        <li>https://developer.mozilla.org/fr/docs/Web/HTTP/Caching_FAQ</li>
                    </ul>
                </section>
            </div>

        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,
                transition: 'slide', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    {src: 'lib/js/classList.js', condition: function () {
                            return !document.body.classList;
                        }},
                    {src: 'plugin/markdown/marked.js', condition: function () {
                            return !!document.querySelector('[data-markdown]');
                        }},
                    {src: 'plugin/markdown/markdown.js', condition: function () {
                            return !!document.querySelector('[data-markdown]');
                        }},
                    {src: 'plugin/highlight/highlight.js', async: true, condition: function () {
                            return !!document.querySelector('pre code');
                        }, callback: function () {
                            hljs.initHighlightingOnLoad();
                        }},
                    {src: 'plugin/zoom-js/zoom.js', async: true},
                    {src: 'plugin/notes/notes.js', async: true}
                ]
            });

        </script>

    </body>
</html>
